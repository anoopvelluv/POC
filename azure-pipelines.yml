  # Docker
  # Build and push an image to Azure Container Registry
  # https://docs.microsoft.com/azure/devops/pipelines/languages/docker

  trigger:
    - main

  resources:
    - repo: self

  variables:
    # Container registry service connection established during pipeline creation
    dockerRegistryServiceConnection: 'a4a24aca-f1e6-4f77-b5a7-3679b2180967'
    imageRepository: 'simulationimage'
    containerRegistry: 'cicdpoc.azurecr.io'
    dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
    tag: '$(Build.BuildId)'

    backendServiceArm: 'simulationdeployPOC-rg'
    backendAzureRmResourceGroupName: 'simulationdeployPOC-rg'

    environment: 'development'
    terraform_version: '1.0.10'

    # Agent VM image name
    vmImageName: 'ubuntu-latest'
    DOCKER_BUILDKIT: 1

  stages:
  - stage: terraform_base
    jobs:
      - template: templates/terraform-apply.yaml
        parameters:
          backendServiceArm: '${{ variables.backendServiceArm }}'
          backendAzureRmResourceGroupName: '${{ variables.backendAzureRmResourceGroupName }}'
          workingDirectory: '$(System.DefaultWorkingDirectory)/terraform_cr/'
          environment: ${{ variables.environment }}
          terraform_version: ${{ variables.terraform_version }}

  - stage: Build
    dependsOn: [ terraform_base ]
    displayName: Build and push stage
    jobs:
      - template: templates/docker.yaml
        parameters:
          repository: ${{ variables.imageRepository }}
          dockerfile: ${{ variables.dockerfilePath }}
          containerRegistry: ${{ variables.dockerRegistryServiceConnection }}
          tag: ${{ variables.tag }}
